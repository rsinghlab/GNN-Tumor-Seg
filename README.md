# GNN-Tumor-Seg
Using Graph Neural Networks to Segment MRIs of Brain Tumors.

This repository contains the code used in our publication xxxx. This model was submitted to the BraTS2021 competition.


# Data Access
The training and validation data for Task 1 of the BraTS2021 competition can be accessed through Synapse (https://www.synapse.org/#!Synapse:syn25829067/wiki/610865). More information on the BraTS competition can be found at http://www.braintumorsegmentation.org.


# Requirements
Numpy>=1.17

Scipy>=1.4

Scikit-image

Networkx

Nibabel

Pytorch>=1.7

DGL>=0.4

Requests

# Provided Bash Scripts

The train_gnn_randomized_hyperparameters and train_cnn_randomized_hyperparameters are provided as examples of how to train a GNN and CNN model with random hyperparameters. These are intended to be used for hyperparameter tuning.
The scripts will train one model with random hyperparameters. The scripts must be run multiple times (e.g. in parallel) in order to train multiple models with different hyperparameters.
Note that prior to running either script the data must first be preprocessed (see below) and a GNN must be trained prior to training a CNN.

The run_pipeline script is intended to demonstrate the flow of training a complete model and generating final predictions once good hyperparameters have been identified. Unlike those above, it trains a model using set hyperparameters and on the complete dataset rather than chunking it into folds. Note that several steps receive their inputs from the output directories of previous steps. Each step is described in more detail below.

For all of these bash scripts you will of course have to adjust the filepaths. Please also note that prior to running any of these scripts the data must first be preprocessed (see below) and a GNN must be trained prior to training a CNN.

# How to use

# Preprocessing

We first preprocess the data provided by the competition into the format used by our model. Specifically, the script preprocess.py accomplishes the following:

    1. Normalize and standardize each image of each MRI modality

    2. Combine multiple MRI modalitities into one image array

    3. Swap labels from BraTS order (0,2,1,4) to more intuitive order (0,1,2,3)

    4. Convert image into a graph. This is done by running a supervoxel creation algorithm on the standardized and combined image and converting each supervoxel into a graph node, with edges between neighboring supervoxels.

The converted data is then stored in a separate directory, which is used as input for subsequent scripts, e.g. training a model.

Example: "python -m scripts.preprocess_dataset -d ~/project_data/BraTS21_data/raw/train -n 15000 -k 0 -b 0.5 -o ~/project_data/BraTS21_data/processed/train -l _seg.nii.gz -p BraTS2021"

The CLI arguments are explained in the script.

# Training GNN

Entrypoint: scripts.train_gnn.py
Example: See scripts.train_gnn_randomized_hyperparameters.sh

Using the graphs generated by the preprocessing step, we train a GNN to predict labels for individual graph nodes. Will train a user defined GNN architecture for a user defined number of epochs.
A standard GNN training implementation, agnostic to the fact that teh graphs represent MRIs.


# Generating GNN Predictions


# Training CNN to Refine GNN Predictions


# Generating Joint GNN-CNN Predictions


# Visualizing Predictions

# How to Modify Hyperparameters
Hyperparameters are set in hyperparam_helpers.py. Hardcoded hyperparameters for a single run can be set by directly modifying the values in the populate_hyperparameter_method.
The distributions for random hyperparameter generation can be modified in the generate_random_hyperparameter method.
All possible hyperparamters are generated, even if the desired model doesn't use them.
This solution works, but is unfortunately not very programmatic.
